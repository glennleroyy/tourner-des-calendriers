<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calentour - Calendrier Pompiers</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet Geocoder pour la recherche d'adresses -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <style>
        /* Style général */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f0f0f0;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* En-tête */
        .header {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            position: relative;
            z-index: 100;
            flex-shrink: 0;
            height: 60px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .calendar-icon {
            font-size: 28px;
            color: white;
            background: #ff9800;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        
        .logo h1 {
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .user-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Boutons */
        button {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #f57c00;
        }
        
        .btn-logout {
            background-color: #555;
        }
        
        .btn-logout:hover {
            background-color: #333;
        }
        
        .btn-reset {
            background-color: #f44336;
        }
        
        .btn-reset:hover {
            background-color: #d32f2f;
        }
        
        .btn-locate {
            background-color: #2196F3;
        }
        
        .btn-locate:hover {
            background-color: #1976D2;
        }
        
        .btn-track {
            background-color: #9C27B0;
        }
        
        .btn-track:hover {
            background-color: #7B1FA2;
        }
        
        .btn-chart {
            background-color: #4CAF50;
        }
        
        .btn-chart:hover {
            background-color: #388E3C;
        }
        
        .btn-add-house {
            background-color: #FF9800;
        }
        
        .btn-add-house:hover {
            background-color: #F57C00;
        }
        
        /* Menu mobile */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
        }
        
        /* Contenu principal - CORRIGÉ POUR PC */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            height: calc(100vh - 60px);
        }
        
        /* Carte - CORRIGÉ POUR PC */
        #map {
            flex: 1;
            height: 100%;
            width: 100%;
            z-index: 1;
            min-height: 400px;
        }
        
        /* Barre latérale */
        .sidebar {
            width: 350px;
            background-color: white;
            padding: 15px;
            overflow-y: auto;
            box-shadow: -3px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: transform 0.3s ease;
            position: relative;
            z-index: 50;
        }
        
        /* Overlay pour mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 49;
        }
        
        /* Sections */
        .section {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e0e0e0;
        }
        
        .section h3 {
            color: #d32f2f;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #d32f2f;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .stat-item {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }
        
        /* Classement */
        .ranking-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            background-color: white;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        
        .rank {
            font-weight: bold;
            color: #d32f2f;
            min-width: 25px;
        }
        
        .rank-1 {
            color: #FFD700; /* Or */
        }
        
        .rank-2 {
            color: #C0C0C0; /* Argent */
        }
        
        .rank-3 {
            color: #CD7F32; /* Bronze */
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #d32f2f;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .user-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        .user-score {
            font-weight: bold;
            color: #333;
            min-width: 40px;
            text-align: right;
        }
        
        /* Légende */
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .color-box {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        
        /* Fenêtre popup */
        .popup-content {
            padding: 10px;
            min-width: 250px;
            max-width: 300px;
        }
        
        .popup-address {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        
        .popup-note {
            font-style: italic;
            background-color: #f5f5f5;
            padding: 6px;
            border-radius: 5px;
            margin-bottom: 12px;
            font-size: 13px;
            word-break: break-word;
        }
        
        .popup-payment {
            margin: 10px 0;
            padding: 10px;
            background-color: #f0f8ff;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        
        .payment-info {
            font-size: 13px;
            color: #333;
        }
        
        .payment-amount {
            font-weight: bold;
            color: #2E7D32;
            margin-right: 5px;
        }
        
        .payment-method {
            color: #1565C0;
            font-style: italic;
        }
        
        .status-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .status-btn {
            padding: 8px 5px;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .status-btn:hover {
            transform: scale(1.05);
        }
        
        .popup-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .btn-delete {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-delete:hover {
            background-color: #d32f2f;
        }
        
        .btn-edit {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-edit:hover {
            background-color: #1976D2;
        }
        
        /* Écran de connexion */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            padding: 20px;
        }
        
        .login-box {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .login-box h2 {
            text-align: center;
            color: #d32f2f;
            margin-bottom: 20px;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-box .calendar-icon {
            background: #d32f2f;
            width: 35px;
            height: 35px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
            font-size: 14px;
        }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #d32f2f;
        }
        
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .remember-me input {
            width: 18px;
            height: 18px;
        }
        
        .remember-me label {
            font-size: 14px;
            color: #555;
            cursor: pointer;
        }
        
        .login-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-login {
            background-color: #d32f2f;
            width: 100%;
            justify-content: center;
            padding: 12px;
        }
        
        .btn-signup {
            background-color: #555;
            width: 100%;
            justify-content: center;
            padding: 12px;
        }
        
        .error-message {
            color: #f44336;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 5px;
            display: none;
            font-size: 14px;
        }
        
        /* Éditeur de note */
        .note-editor {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .note-editor h3 {
            margin-bottom: 15px;
            color: #d32f2f;
        }
        
        .note-editor textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .note-editor textarea:focus {
            outline: none;
            border-color: #d32f2f;
        }
        
        .note-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Popup de paiement */
        .payment-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            z-index: 1000;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .payment-popup h3 {
            color: #d32f2f;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .payment-popup .input-group {
            margin-bottom: 15px;
        }
        
        .payment-popup .input-group label {
            font-size: 14px;
            color: #555;
            margin-bottom: 8px;
            display: block;
        }
        
        .payment-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .payment-option {
            flex: 1;
            min-width: 100px;
        }
        
        .payment-option input[type="radio"] {
            display: none;
        }
        
        .payment-option label {
            display: block;
            padding: 10px;
            background-color: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-option input[type="radio"]:checked + label {
            background-color: #d32f2f;
            color: white;
            border-color: #d32f2f;
        }
        
        .payment-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Page des graphiques */
        .chart-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #d32f2f;
        }
        
        .chart-header h2 {
            color: #d32f2f;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .chart-card h3 {
            color: #d32f2f;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 250px;
            width: 100%;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .stats-table th {
            background-color: #d32f2f;
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .stats-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .stats-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #f0f8ff;
        }
        
        /* Chargement */
        .loader {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 6px solid rgba(211, 47, 47, 0.3);
            border-top: 6px solid #d32f2f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Style pour le marqueur de position utilisateur */
        .user-location-marker {
            background-color: #2196F3;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-location-pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(33, 150, 243, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(33, 150, 243, 0);
            }
        }
        
        /* Bouton flottant pour mobile */
        .floating-locate {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .floating-locate button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #2196F3;
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* Bouton flottant pour ajouter une maison */
        .floating-add {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
        }
        
        .floating-add button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #FF9800;
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* Animation pour les points */
        @keyframes housePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .new-house {
            animation: housePulse 0.5s ease-in-out 3;
        }
        
        /* Barre de recherche */
        .leaflet-control-geocoder {
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .leaflet-control-geocoder-form {
            width: 250px;
        }
        
        .leaflet-control-geocoder-form input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        
        /* Instructions pour l'adresse */
        .address-instructions {
            background-color: #e8f5e8;
            border-left: 4px solid #4CAF50;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 13px;
        }
        
        /* Responsive - Mobile */
        @media (max-width: 768px) {
            .header {
                padding: 10px;
                height: 60px;
            }
            
            .logo h1 {
                font-size: 18px;
            }
            
            .calendar-icon {
                width: 35px;
                height: 35px;
                font-size: 24px;
            }
            
            .menu-toggle {
                display: flex;
            }
            
            .user-section {
                display: none;
                position: absolute;
                top: 60px;
                right: 0;
                background-color: #d32f2f;
                padding: 15px;
                border-radius: 0 0 0 10px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                z-index: 101;
                flex-direction: column;
                width: 200px;
                gap: 8px;
            }
            
            .user-section.mobile-visible {
                display: flex;
            }
            
            .container {
                flex-direction: column;
                height: calc(100vh - 60px);
            }
            
            #map {
                height: 100%;
                width: 100%;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
            }
            
            .sidebar {
                position: fixed;
                right: 0;
                top: 60px;
                bottom: 0;
                width: 85%;
                max-width: 320px;
                transform: translateX(100%);
                z-index: 100;
                background-color: white;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar-overlay.active {
                display: block;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stat-number {
                font-size: 18px;
            }
            
            button {
                padding: 6px 10px;
                font-size: 13px;
            }
            
            .popup-content {
                min-width: 220px;
                max-width: 280px;
            }
            
            .payment-popup {
                padding: 20px;
                max-width: 90%;
            }
            
            .chart-container {
                grid-template-columns: 1fr;
            }
            
            .chart-card {
                padding: 15px;
            }
            
            .chart-wrapper {
                height: 200px;
            }
            
            .floating-locate {
                display: block;
            }
            
            .floating-add {
                display: block;
            }
            
            .leaflet-control-geocoder-form {
                width: 200px;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                width: 90%;
            }
            
            .login-box {
                padding: 20px;
            }
            
            .login-box h2 {
                font-size: 20px;
            }
            
            .section {
                padding: 12px;
            }
            
            .section h3 {
                font-size: 15px;
            }
            
            .chart-screen {
                padding: 15px;
            }
            
            .leaflet-control-geocoder-form {
                width: 150px;
            }
        }
        
        /* Pour PC - Correction supplémentaire */
        @media (min-width: 769px) {
            .container {
                height: calc(100vh - 60px);
            }
            
            #map {
                height: 100%;
                min-height: 500px;
            }
            
            .floating-add {
                display: block;
                bottom: 90px;
                right: 20px;
            }
        }
        
        /* Barre de défilement */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #d32f2f;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #b71c1c;
        }
    </style>
</head>
<body>

<!-- Écran de connexion -->
<div id="loginScreen" class="login-screen">
    <div class="login-box">
        <h2>
            <div class="calendar-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            Calentour
        </h2>
        <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 14px;">
            Tournée du calendrier des pompiers
        </p>
        
        <div class="input-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="votre@email.com">
        </div>
        
        <div class="input-group">
            <label for="pseudo">Pseudo (visible par tous)</label>
            <input type="text" id="pseudo" placeholder="Votre pseudo">
        </div>
        
        <div class="input-group">
            <label for="password">Mot de passe</label>
            <input type="password" id="password" placeholder="Votre mot de passe">
        </div>
        
        <div class="remember-me">
            <input type="checkbox" id="rememberMe">
            <label for="rememberMe">Se souvenir de moi</label>
        </div>
        
        <div class="login-buttons">
            <button id="btnLogin" class="btn-login">
                <i class="fas fa-sign-in-alt"></i> Se connecter
            </button>
            <button id="btnSignup" class="btn-signup">
                <i class="fas fa-user-plus"></i> Créer un compte
            </button>
        </div>
        
        <div id="errorMessage" class="error-message"></div>
    </div>
</div>

<!-- Application principale -->
<div id="app" style="display: none;">
    <div class="header">
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="logo">
            <div class="calendar-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <h1>Calentour</h1>
        </div>
        
        <button class="menu-toggle" id="userToggle">
            <i class="fas fa-user"></i>
        </button>
        
        <div class="user-section" id="userSection">
            <button id="btnAddHouse" class="btn-add-house">
                <i class="fas fa-plus"></i> Ajouter une maison
            </button>
            <button id="btnChart" class="btn-chart">
                <i class="fas fa-chart-pie"></i> Statistiques
            </button>
            <button id="btnLocate" class="btn-locate">
                <i class="fas fa-location-arrow"></i> Ma position
            </button>
            <button id="btnTrack" class="btn-track">
                <i class="fas fa-satellite"></i> Suivre
            </button>
            <span id="userPseudo"></span>
            <button id="btnLogout" class="btn-logout">
                <i class="fas fa-sign-out-alt"></i> Déconnexion
            </button>
            <button id="btnReset" class="btn-reset" style="display: none;">
                <i class="fas fa-trash"></i> Reset
            </button>
        </div>
    </div>
    
    <div class="container">
        <div id="map"></div>
        
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <div class="sidebar" id="sidebar">
            <div class="section">
                <h3><i class="fas fa-chart-bar"></i> Mes Statistiques</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="statTotal">0</div>
                        <div class="stat-label">Total maisons</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="statBought">0</div>
                        <div class="stat-label">Achetés</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="statNotBought">0</div>
                        <div class="stat-label">Non achetés</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="statAbsent">0</div>
                        <div class="stat-label">Absents</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-trophy"></i> Classement</h3>
                <div class="ranking-list" id="rankingList">
                    <div style="text-align: center; color: #888; padding: 20px;">Chargement...</div>
                </div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-key"></i> Légende</h3>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #9E9E9E;"></div>
                    <span>Non passé</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #4CAF50;"></div>
                    <span>Acheté</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #FF5722;"></div>
                    <span>Non acheté</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #2196F3;"></div>
                    <span>Absent</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #2196F3; border: 2px dashed #fff;"></div>
                    <span>Votre position</span>
                </div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-info-circle"></i> Instructions</h3>
                <p style="font-size: 13px; line-height: 1.4; color: #555;">
                    1. <strong>Bouton "Ajouter une maison"</strong> : pour placer une nouvelle adresse<br>
                    2. <strong>Cliquez sur un point</strong> pour changer le statut<br>
                    3. <strong>Bouton "Ma position"</strong> : vous localise sur la carte<br>
                    4. <strong>Bouton "Suivre"</strong> : suit votre déplacement<br>
                    5. <strong>Classement</strong> : 10pts acheté, 5pts absent, 1pt non acheté<br>
                    6. <strong>Statistiques</strong> : voir tous les paiements<br>
                    7. <strong>RESET</strong> : admin seulement<br>
                    8. <strong>Utilisez la barre de recherche</strong> pour trouver des adresses
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Page des graphiques -->
<div id="chartScreen" class="chart-screen">
    <div class="chart-header">
        <h2><i class="fas fa-chart-pie"></i> Statistiques des Paiements</h2>
        <button id="btnCloseChart" style="background-color: #777;">
            <i class="fas fa-times"></i> Fermer
        </button>
    </div>
    
    <div class="chart-container">
        <div class="chart-card">
            <h3><i class="fas fa-chart-pie"></i> Répartition des Moyens de Paiement</h3>
            <div class="chart-wrapper">
                <canvas id="paymentMethodChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <h3><i class="fas fa-euro-sign"></i> Répartition des Montants</h3>
            <div class="chart-wrapper">
                <canvas id="amountChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <h3><i class="fas fa-users"></i> Top Utilisateurs par Recettes</h3>
            <div class="chart-wrapper">
                <canvas id="userRevenueChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <h3><i class="fas fa-calendar"></i> Évolution des Ventes</h3>
            <div class="chart-wrapper">
                <canvas id="salesChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h3><i class="fas fa-table"></i> Détails des Paiements</h3>
        <div style="overflow-x: auto;">
            <table class="stats-table" id="paymentsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Utilisateur</th>
                        <th>Adresse</th>
                        <th>Montant</th>
                        <th>Moyen</th>
                        <th>Note</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Les données seront insérées ici par JavaScript -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="3"><strong>TOTAL GÉNÉRAL</strong></td>
                        <td id="totalAmount">0.00€</td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Bouton flottant pour mobile -->
<div id="floatingLocate" class="floating-locate">
    <button>
        <i class="fas fa-location-arrow"></i>
    </button>
</div>

<!-- Bouton flottant pour ajouter une maison -->
<div id="floatingAdd" class="floating-add">
    <button id="btnFloatingAdd">
        <i class="fas fa-plus"></i>
    </button>
</div>

<!-- Éditeur de note -->
<div id="noteEditor" class="note-editor">
    <h3>Modifier la note</h3>
    <textarea id="noteText" placeholder="Ex: Repasser après 18h, 2ème étage, chien méchant..."></textarea>
    <div class="note-buttons">
        <button id="btnCancelNote" style="background-color: #777;">Annuler</button>
        <button id="btnSaveNote" style="background-color: #d32f2f;">Enregistrer</button>
    </div>
</div>

<!-- Popup de paiement -->
<div id="paymentPopup" class="payment-popup">
    <h3><i class="fas fa-euro-sign"></i> Informations de paiement</h3>
    
    <div class="input-group">
        <label for="editAddress">Adresse de la maison</label>
        <div class="address-instructions">
            <i class="fas fa-info-circle"></i> Exemples :<br>
            • 2 rue du Soleil<br>
            • 15 avenue des Champs-Élysées<br>
            • 8 bis rue de la République
        </div>
        <textarea id="editAddress" placeholder="Ex: 2 rue du Soleil, 75000 Paris" rows="2"></textarea>
    </div>
    
    <div class="input-group">
        <label for="paymentAmount">Montant payé (€)</label>
        <input type="number" id="paymentAmount" min="0" step="0.01" placeholder="Ex: 5.00">
    </div>
    
    <div class="input-group">
        <label>Moyen de paiement</label>
        <div class="payment-options">
            <div class="payment-option">
                <input type="radio" id="cash" name="paymentMethod" value="espèces">
                <label for="cash">
                    <i class="fas fa-money-bill-wave"></i><br>
                    Espèces
                </label>
            </div>
            <div class="payment-option">
                <input type="radio" id="check" name="paymentMethod" value="chèque">
                <label for="check">
                    <i class="fas fa-money-check"></i><br>
                    Chèque
                </label>
            </div>
            <div class="payment-option">
                <input type="radio" id="card" name="paymentMethod" value="carte">
                <label for="card">
                    <i class="fas fa-credit-card"></i><br>
                    Carte
                </label>
            </div>
        </div>
    </div>
    
    <div class="input-group">
        <label for="additionalNote">Note supplémentaire (facultatif)</label>
        <textarea id="additionalNote" placeholder="Ex: A récupérer le reçu, 2ème étage à gauche..." rows="2"></textarea>
    </div>
    
    <div class="payment-buttons">
        <button id="btnCancelPayment" style="background-color: #777;">Annuler</button>
        <button id="btnSavePayment" style="background-color: #4CAF50;">Enregistrer</button>
    </div>
</div>

<!-- Chargement -->
<div id="loader" class="loader">
    <div class="spinner"></div>
</div>

<!-- Script JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// CONFIGURATION
let map;
let markers = new Map();
let currentUser = null;
let editingMarkerId = null;
let newHouseData = null;
let charts = {};
let geocoder = null;
let isAddingHouse = false;

// Variables pour la géolocalisation
let userLocationMarker = null;
let userLocationCircle = null;
let isTrackingLocation = false;
let watchId = null;

// Email de l'admin (VOUS)
const ADMIN_EMAIL = "objectifcup@gmail.com";

// Données (stockage local)
let houses = JSON.parse(localStorage.getItem('calentour_houses')) || [];
let users = JSON.parse(localStorage.getItem('calentour_users')) || [];
let rememberMe = localStorage.getItem('calentour_remember') || false;

// Système de points
const POINTS = {
    'acheté': 10,
    'absent': 5,
    'non_acheté': 1,
    'non_passé': 0
};

// Statuts des maisons
const STATUS = {
    NOT_PASSED: 'non_passé',
    BOUGHT: 'acheté',
    NOT_BOUGHT: 'non_acheté',
    ABSENT: 'absent'
};

// Couleurs pour chaque statut
const STATUS_COLORS = {
    'non_passé': '#9E9E9E',
    'acheté': '#4CAF50',
    'non_acheté': '#FF5722',
    'absent': '#2196F3'
};

// Couleurs pour les graphiques
const CHART_COLORS = {
    espèces: '#4CAF50',
    chèque: '#2196F3',
    carte: '#FF9800',
    autres: '#9C27B0'
};

// Création des icônes pour la carte
const STATUS_ICONS = {};
for (const [status, color] of Object.entries(STATUS_COLORS)) {
    STATUS_ICONS[status] = L.divIcon({
        html: `<div style="background-color: ${color}; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>`,
        iconSize: [25, 25],
        iconAnchor: [12, 12],
        className: 'house-marker'
    });
}

// Liste d'adresses types pour la Bretagne
const BRITTANY_ADDRESSES = [
    "Place de la Mairie",
    "Rue du Port",
    "Rue de l'Église",
    "Place du Marché",
    "Avenue de la Gare",
    "Rue des Écoles",
    "Boulevard de la Mer",
    "Rue du Château",
    "Place de la Liberté",
    "Rue du Stade",
    "Allée des Pommiers",
    "Chemin de la Forêt",
    "Impasse du Moulin",
    "Route de la Plage",
    "Avenue des Hortensias"
];

// Liste de noms de rues pour la Bretagne
const BRITTANY_STREET_NAMES = [
    "du Goëlo", "d'Armor", "de Cornouaille", "de l'Iroise", "du Morbihan",
    "des Ajoncs", "du Genêt", "de l'Océan", "des Goélands", "des Mouettes",
    "de la Rance", "du Blavet", "de la Vilaine", "de l'Elorn", "de l'Aulne",
    "de Brocéliande", "des Menhirs", "des Dolmens", "des Korrigans",
    "de la Bigoudène", "du Marin", "du Pêcheur", "du Sabotier", "du Tisserand"
];

// FONCTIONS UTILITAIRES

// Générer une adresse aléatoire pour la Bretagne
function generateRandomAddress() {
    const streetNumber = Math.floor(Math.random() * 99) + 1;
    const streetType = Math.random() > 0.3 ? "rue" : "avenue";
    const streetName = BRITTANY_STREET_NAMES[Math.floor(Math.random() * BRITTANY_STREET_NAMES.length)];
    const city = "Bretagne";
    
    // 30% de chance d'avoir un bis/ter
    let bisTer = "";
    if (Math.random() > 0.7) {
        bisTer = " " + (Math.random() > 0.5 ? "bis" : "ter");
    }
    
    return `${streetNumber}${bisTer} ${streetType} ${streetName}, ${city}`;
}

// Géocoder une adresse (transformer une adresse texte en coordonnées GPS)
function geocodeAddress(address, callback) {
    if (!geocoder) {
        console.error("Geocoder non initialisé");
        return;
    }
    
    showLoader();
    
    geocoder.geocode(address, function(results) {
        hideLoader();
        
        if (results && results.length > 0) {
            const result = results[0];
            callback({
                lat: result.center.lat,
                lng: result.center.lng,
                address: result.name || address,
                fullAddress: result.properties.display_name || address
            });
        } else {
            alert("Adresse non trouvée. Veuillez essayer une adresse plus précise.");
            callback(null);
        }
    });
}

// Récupérer les initiales d'un pseudo
function getInitials(name) {
    return name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2);
}

// Calculer le score d'un utilisateur
function calculateUserScore(email) {
    const userHouses = houses.filter(house => house.createdBy === email);
    return userHouses.reduce((total, house) => total + (POINTS[house.status] || 0), 0);
}

// Calculer tous les scores
function calculateAllScores() {
    const scores = {};
    
    users.forEach(user => {
        scores[user.email] = {
            pseudo: user.pseudo,
            score: calculateUserScore(user.email),
            email: user.email
        };
    });
    
    return Object.values(scores).sort((a, b) => b.score - a.score);
}

// FONCTIONS POUR "SE SOUVENIR DE MOI"
function saveRememberMe(email, pseudo, remember) {
    if (remember) {
        localStorage.setItem('calentour_remember', JSON.stringify({
            email: email,
            pseudo: pseudo,
            timestamp: Date.now()
        }));
    } else {
        localStorage.removeItem('calentour_remember');
    }
}

function loadRememberMe() {
    try {
        const saved = JSON.parse(localStorage.getItem('calentour_remember'));
        if (saved && saved.email && saved.pseudo) {
            const thirtyDays = 30 * 24 * 60 * 60 * 1000;
            if (Date.now() - saved.timestamp < thirtyDays) {
                document.getElementById('email').value = saved.email;
                document.getElementById('pseudo').value = saved.pseudo;
                document.getElementById('rememberMe').checked = true;
                return true;
            }
        }
    } catch (e) {
        console.error("Erreur lors du chargement de 'Se souvenir de moi':", e);
    }
    return false;
}

// FONCTIONS POUR LES GRAPHIQUES
function showChartScreen() {
    document.getElementById('chartScreen').style.display = 'block';
    updateCharts();
}

function hideChartScreen() {
    document.getElementById('chartScreen').style.display = 'none';
    Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
    });
    charts = {};
}

function updateCharts() {
    const paidHouses = houses.filter(house => house.payment && house.status === STATUS.BOUGHT);
    
    if (paidHouses.length === 0) {
        document.getElementById('paymentsTable').innerHTML = 
            '<tr><td colspan="6" style="text-align: center; padding: 20px;">Aucun paiement enregistré</td></tr>';
        return;
    }
    
    // 1. Répartition des moyens de paiement
    const paymentMethods = {};
    paidHouses.forEach(house => {
        const method = house.payment.method;
        paymentMethods[method] = (paymentMethods[method] || 0) + 1;
    });
    
    // 2. Répartition des montants
    const amountRanges = {
        '0-2€': { min: 0, max: 2, count: 0, total: 0 },
        '2-5€': { min: 2, max: 5, count: 0, total: 0 },
        '5-10€': { min: 5, max: 10, count: 0, total: 0 },
        '10€+': { min: 10, max: Infinity, count: 0, total: 0 }
    };
    
    paidHouses.forEach(house => {
        const amount = house.payment.amount;
        for (const [range, data] of Object.entries(amountRanges)) {
            if (amount >= data.min && amount < data.max) {
                data.count++;
                data.total += amount;
                break;
            }
        }
    });
    
    // 3. Top utilisateurs par recettes
    const userRevenue = {};
    paidHouses.forEach(house => {
        const user = users.find(u => u.email === house.createdBy);
        const userName = user ? user.pseudo : 'Inconnu';
        userRevenue[userName] = (userRevenue[userName] || 0) + house.payment.amount;
    });
    
    const topUsers = Object.entries(userRevenue)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    
    // 4. Évolution des ventes par date
    const salesByDate = {};
    paidHouses.forEach(house => {
        const date = new Date(house.createdAt).toLocaleDateString('fr-FR', { 
            day: '2-digit', 
            month: 'short' 
        });
        salesByDate[date] = (salesByDate[date] || 0) + house.payment.amount;
    });
    
    // Créer ou mettre à jour les graphiques
    createOrUpdateChart('paymentMethodChart', {
        type: 'pie',
        data: {
            labels: Object.keys(paymentMethods),
            datasets: [{
                data: Object.values(paymentMethods),
                backgroundColor: Object.keys(paymentMethods).map(method => 
                    CHART_COLORS[method] || CHART_COLORS.autres
                ),
                borderWidth: 2,
                borderColor: 'white'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    createOrUpdateChart('amountChart', {
        type: 'doughnut',
        data: {
            labels: Object.keys(amountRanges),
            datasets: [{
                data: Object.values(amountRanges).map(range => range.count),
                backgroundColor: ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0'],
                borderWidth: 2,
                borderColor: 'white'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const range = context.label;
                            const count = context.raw;
                            const data = amountRanges[range];
                            const avg = data.count > 0 ? (data.total / data.count).toFixed(2) : 0;
                            return `${range}: ${count} ventes (moy: ${avg}€)`;
                        }
                    }
                }
            }
        }
    });
    
    createOrUpdateChart('userRevenueChart', {
        type: 'bar',
        data: {
            labels: topUsers.map(user => user[0]),
            datasets: [{
                label: 'Recettes (€)',
                data: topUsers.map(user => user[1]),
                backgroundColor: '#d32f2f',
                borderColor: '#b71c1c',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Montant (€)'
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
    
    createOrUpdateChart('salesChart', {
        type: 'line',
        data: {
            labels: Object.keys(salesByDate),
            datasets: [{
                label: 'Ventes journalières (€)',
                data: Object.values(salesByDate),
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Montant (€)'
                    }
                }
            }
        }
    });
    
    updatePaymentsTable(paidHouses);
}

function createOrUpdateChart(canvasId, config) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }
    
    charts[canvasId] = new Chart(ctx, config);
}

function updatePaymentsTable(paidHouses) {
    const tbody = document.querySelector('#paymentsTable tbody');
    let html = '';
    let totalAmount = 0;
    
    paidHouses.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    paidHouses.forEach(house => {
        const user = users.find(u => u.email === house.createdBy);
        const userName = user ? user.pseudo : 'Inconnu';
        const date = new Date(house.createdAt).toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        const amount = house.payment.amount.toFixed(2);
        totalAmount += house.payment.amount;
        
        html += `
            <tr>
                <td>${date}</td>
                <td>${userName}</td>
                <td style="max-width: 200px; word-wrap: break-word;">${house.address}</td>
                <td><strong>${amount}€</strong></td>
                <td>${house.payment.method}</td>
                <td style="max-width: 150px; word-wrap: break-word;">${house.note || '-'}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    document.getElementById('totalAmount').textContent = totalAmount.toFixed(2) + '€';
}

// FONCTIONS DE GÉOLOCALISATION
function locateUser() {
    if (!navigator.geolocation) {
        alert("La géolocalisation n'est pas supportée par votre navigateur");
        return;
    }
    
    showLoader();
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            if (!isInBrittany(lat, lng)) {
                hideLoader();
                if (!confirm("Vous semblez être en dehors de la Bretagne. Voulez-vous quand même centrer la carte sur votre position ?")) {
                    return;
                }
            }
            
            map.setView([lat, lng], 16);
            updateUserLocationMarker(lat, lng, accuracy);
            hideLoader();
        },
        function(error) {
            hideLoader();
            let errorMessage;
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Vous avez refusé la géolocalisation. Activez-la dans les paramètres de votre navigateur.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Les informations de localisation sont indisponibles.";
                    break;
                case error.TIMEOUT:
                    errorMessage = "La requête de localisation a expiré.";
                    break;
                default:
                    errorMessage = "Une erreur inconnue est survenue.";
            }
            alert("Erreur de géolocalisation : " + errorMessage);
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

function toggleLocationTracking() {
    if (!navigator.geolocation) {
        alert("La géolocalisation n'est pas supportée par votre navigateur");
        return;
    }
    
    if (isTrackingLocation) {
        navigator.geolocation.clearWatch(watchId);
        isTrackingLocation = false;
        document.getElementById('btnTrack').innerHTML = '<i class="fas fa-satellite"></i> Suivre';
    } else {
        showLoader();
        
        watchId = navigator.geolocation.watchPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                updateUserLocationMarker(lat, lng, accuracy);
                
                if (!isTrackingLocation) {
                    map.setView([lat, lng], 16);
                }
                
                isTrackingLocation = true;
                hideLoader();
                document.getElementById('btnTrack').innerHTML = '<i class="fas fa-satellite-dish"></i> Arrêter';
            },
            function(error) {
                hideLoader();
                if (error.code === error.PERMISSION_DENIED) {
                    alert("Permission de géolocalisation refusée. Activez-la dans les paramètres.");
                }
            },
            {
                enableHighAccuracy: true,
                maximumAge: 10000,
                timeout: 5000
            }
        );
    }
}

function updateUserLocationMarker(lat, lng, accuracy) {
    if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
    }
    if (userLocationCircle) {
        map.removeLayer(userLocationCircle);
    }
    
    const userIcon = L.divIcon({
        html: `<div class="user-location-marker user-location-pulse">
                  <i class="fas fa-user" style="color: white; font-size: 10px;"></i>
               </div>`,
        iconSize: [20, 20],
        iconAnchor: [10, 10],
        className: 'user-location-icon'
    });
    
    userLocationMarker = L.marker([lat, lng], {
        icon: userIcon,
        zIndexOffset: 1000
    }).addTo(map);
    
    if (accuracy < 1000) {
        userLocationCircle = L.circle([lat, lng], {
            color: '#2196F3',
            fillColor: '#2196F3',
            fillOpacity: 0.1,
            radius: accuracy
        }).addTo(map);
    }
    
    userLocationMarker.bindPopup(`
        <div style="text-align: center; padding: 5px;">
            <strong>Votre position</strong><br>
            Précision: ${Math.round(accuracy)} mètres<br>
            <small>${lat.toFixed(5)}, ${lng.toFixed(5)}</small>
        </div>
    `);
}

function isInBrittany(lat, lng) {
    return lat >= 47.0 && lat <= 49.0 && lng >= -5.0 && lng <= -1.0;
}

function showLoader() {
    document.getElementById('loader').style.display = 'block';
}

function hideLoader() {
    document.getElementById('loader').style.display = 'none';
}

// Mettre à jour le classement
function updateRanking() {
    const scores = calculateAllScores();
    const rankingList = document.getElementById('rankingList');
    
    if (scores.length === 0) {
        rankingList.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">Aucun score disponible</div>';
        return;
    }
    
    let html = '';
    scores.forEach((user, index) => {
        const rankClass = `rank rank-${index + 1}`;
        const initials = getInitials(user.pseudo);
        
        html += `
            <div class="ranking-item">
                <span class="${rankClass}">${index + 1}</span>
                <div class="user-info">
                    <div class="user-avatar" style="background-color: ${index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : '#d32f2f'}">
                        ${initials}
                    </div>
                    <span class="user-name">${user.pseudo}</span>
                </div>
                <span class="user-score">${user.score} pts</span>
            </div>
        `;
    });
    
    rankingList.innerHTML = html;
}

// INITIALISATION DE LA CARTE
function initMap() {
    console.log("🗺️ Initialisation de la carte de Bretagne...");
    
    if (map) {
        map.remove();
    }
    
    map = L.map('map');
    map.setView([48.2020, -2.9326], 9);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap',
        maxZoom: 18,
        minZoom: 8
    }).addTo(map);
    
    const bounds = L.latLngBounds(
        [47.0, -5.0],
        [49.0, -1.0]
    );
    
    if (window.innerWidth > 768) {
        map.setMaxBounds(bounds);
    }
    
    // Ajouter le geocoder (recherche d'adresse)
    geocoder = L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: "Rechercher une adresse...",
        errorMessage: "Adresse non trouvée"
    }).addTo(map);
    
    // Événement quand une adresse est trouvée
    geocoder.on('markgeocode', function(e) {
        const center = e.geocode.center;
        const address = e.geocode.name;
        
        map.setView(center, 16);
        
        // Si on est en mode ajout de maison, pré-remplir l'adresse
        if (isAddingHouse) {
            document.getElementById('editAddress').value = address;
            newHouseData = {
                lat: center.lat,
                lng: center.lng,
                address: address
            };
        }
    });
    
    // Désactiver le clic sur la carte pour ajouter des maisons
    // (on utilise maintenant le bouton "Ajouter une maison")
    map.on('click', function(e) {
        // On ne fait rien au clic sur la carte
        // L'ajout se fait via le bouton et la géolocalisation
    });
    
    setTimeout(() => {
        map.invalidateSize();
    }, 100);
}

// FONCTIONS POUR LE POPUP DE PAIEMENT
function showPaymentPopup(lat, lng, address) {
    // Si on a une adresse, l'utiliser, sinon générer une adresse aléatoire
    const defaultAddress = address || generateRandomAddress();
    
    newHouseData = {
        lat: lat,
        lng: lng,
        address: defaultAddress
    };
    
    document.getElementById('editAddress').value = defaultAddress;
    document.getElementById('paymentAmount').value = '';
    document.getElementById('additionalNote').value = '';
    
    const paymentMethods = document.getElementsByName('paymentMethod');
    paymentMethods.forEach(method => {
        method.checked = false;
    });
    
    document.getElementById('paymentPopup').style.display = 'block';
    isAddingHouse = true;
}

function hidePaymentPopup() {
    document.getElementById('paymentPopup').style.display = 'none';
    newHouseData = null;
    isAddingHouse = false;
}

function savePaymentInfo() {
    if (!newHouseData) return;
    
    const address = document.getElementById('editAddress').value.trim();
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
    const additionalNote = document.getElementById('additionalNote').value.trim();
    
    if (!address) {
        alert("Veuillez saisir une adresse");
        return;
    }
    
    if (isNaN(amount) || amount < 0) {
        alert("Veuillez saisir un montant valide");
        return;
    }
    
    if (!paymentMethod) {
        alert("Veuillez sélectionner un moyen de paiement");
        return;
    }
    
    // Si l'adresse a changé, géocoder la nouvelle adresse
    if (address !== newHouseData.address) {
        showLoader();
        geocodeAddress(address, function(result) {
            hideLoader();
            
            if (result) {
                // Utiliser les nouvelles coordonnées
                newHouseData.lat = result.lat;
                newHouseData.lng = result.lng;
                newHouseData.address = result.address;
                createHouseWithPayment(amount, paymentMethod.value, additionalNote);
            }
        });
    } else {
        // Utiliser les coordonnées existantes
        createHouseWithPayment(amount, paymentMethod.value, additionalNote);
    }
}

function createHouseWithPayment(amount, paymentMethod, additionalNote) {
    const id = 'house_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    const house = {
        id: id,
        lat: newHouseData.lat,
        lng: newHouseData.lng,
        address: newHouseData.address,
        status: STATUS.BOUGHT,
        note: additionalNote,
        payment: {
            amount: amount,
            method: paymentMethod,
            date: new Date().toISOString()
        },
        createdBy: currentUser.email,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };
    
    houses.push(house);
    saveHouses();
    addMarker(house);
    updateStats();
    updateRanking();
    hidePaymentPopup();
    
    alert(`Maison ajoutée avec succès !\nAdresse: ${newHouseData.address}\nMontant: ${amount}€\nMoyen de paiement: ${paymentMethod}`);
}

// GESTION DES MAISONS
function updateHouseStatus(id, newStatus) {
    const house = houses.find(h => h.id === id);
    if (house) {
        house.status = newStatus;
        house.updatedAt = new Date().toISOString();
        
        if (newStatus !== STATUS.BOUGHT) {
            delete house.payment;
        }
        
        updateMarker(house);
        saveHouses();
        updateStats();
        updateRanking();
    }
}

function updateHouseNote(id, newNote) {
    const house = houses.find(h => h.id === id);
    if (house) {
        house.note = newNote;
        house.updatedAt = new Date().toISOString();
        updateMarker(house);
        saveHouses();
    }
}

function updateHouseAddress(id, newAddress) {
    const house = houses.find(h => h.id === id);
    if (house) {
        // Géocoder la nouvelle adresse
        showLoader();
        geocodeAddress(newAddress, function(result) {
            hideLoader();
            
            if (result) {
                house.address = result.address;
                house.lat = result.lat;
                house.lng = result.lng;
                house.updatedAt = new Date().toISOString();
                updateMarker(house);
                saveHouses();
                
                // Recharger le popup
                const marker = markers.get(id);
                if (marker) {
                    marker.closePopup();
                    setTimeout(() => {
                        marker.openPopup();
                    }, 100);
                }
            } else {
                alert("Adresse non trouvée. Veuillez essayer une adresse plus précise.");
            }
        });
        return true;
    }
    return false;
}

function deleteHouse(id) {
    houses = houses.filter(h => h.id !== id);
    removeMarker(id);
    saveHouses();
    updateStats();
    updateRanking();
}

function saveHouses() {
    localStorage.setItem('calentour_houses', JSON.stringify(houses));
}

function saveUsers() {
    localStorage.setItem('calentour_users', JSON.stringify(users));
}

// GESTION DES MARQUEURS
function addMarker(house) {
    const marker = L.marker([house.lat, house.lng], {
        icon: STATUS_ICONS[house.status],
        title: house.address
    }).addTo(map);
    
    markers.set(house.id, marker);
    
    marker.bindPopup(createPopupContent(house), {
        maxWidth: 300
    });
    
    marker.getElement().classList.add('new-house');
    
    marker.on('popupopen', function() {
        setTimeout(() => {
            const popupElement = marker.getPopup().getElement();
            
            const statusButtons = popupElement.querySelectorAll('.status-btn');
            statusButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const houseId = this.getAttribute('data-id');
                    const newStatus = this.getAttribute('data-status');
                    updateHouseStatus(houseId, newStatus);
                    marker.closePopup();
                    setTimeout(() => {
                        marker.openPopup();
                    }, 100);
                });
            });
            
            const deleteBtn = popupElement.querySelector('.btn-delete');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const houseId = this.getAttribute('data-id');
                    if (confirm('Voulez-vous vraiment supprimer cette maison ?')) {
                        deleteHouse(houseId);
                    }
                });
            }
            
            const editNoteBtn = popupElement.querySelector('.btn-edit-note');
            if (editNoteBtn) {
                editNoteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const houseId = this.getAttribute('data-id');
                    editNote(houseId);
                });
            }
            
            const editAddressBtn = popupElement.querySelector('.btn-edit-address');
            if (editAddressBtn) {
                editAddressBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const houseId = this.getAttribute('data-id');
                    editAddressPopup(houseId);
                });
            }
        }, 10);
    });
}

function updateMarker(house) {
    const marker = markers.get(house.id);
    if (marker) {
        marker.setIcon(STATUS_ICONS[house.status]);
        marker.setPopupContent(createPopupContent(house));
    }
}

function removeMarker(id) {
    const marker = markers.get(id);
    if (marker) {
        map.removeLayer(marker);
        markers.delete(id);
    }
}

function createPopupContent(house) {
    const user = users.find(u => u.email === house.createdBy);
    const creatorName = user ? user.pseudo : 'Inconnu';
    
    let paymentInfo = '';
    if (house.payment && house.status === STATUS.BOUGHT) {
        paymentInfo = `
            <div class="popup-payment">
                <div class="payment-info">
                    <span class="payment-amount">${house.payment.amount}€</span>
                    payé par <span class="payment-method">${house.payment.method}</span>
                </div>
            </div>
        `;
    }
    
    return `
        <div class="popup-content">
            <div class="popup-address">${house.address}</div>
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                <i class="fas fa-user"></i> Ajouté par ${creatorName}
            </div>
            ${paymentInfo}
            ${house.note ? `<div class="popup-note">${house.note}</div>` : ''}
            
            <div class="status-buttons">
                <button class="status-btn" data-id="${house.id}" data-status="non_passé" 
                        style="background-color: ${STATUS_COLORS['non_passé']}">
                    Non passé
                </button>
                <button class="status-btn" data-id="${house.id}" data-status="acheté" 
                        style="background-color: ${STATUS_COLORS['acheté']}">
                    Acheté
                </button>
                <button class="status-btn" data-id="${house.id}" data-status="non_acheté" 
                        style="background-color: ${STATUS_COLORS['non_acheté']}">
                    Non acheté
                </button>
                <button class="status-btn" data-id="${house.id}" data-status="absent" 
                        style="background-color: ${STATUS_COLORS['absent']}">
                    Absent
                </button>
            </div>
            
            <div class="popup-actions">
                <button class="btn-edit-note" data-id="${house.id}">
                    <i class="fas fa-edit"></i> Note
                </button>
                <button class="btn-edit-address" data-id="${house.id}">
                    <i class="fas fa-home"></i> Adresse
                </button>
                <button class="btn-delete" data-id="${house.id}">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        </div>
    `;
}

// ÉDITION D'ADRESSE
function editAddressPopup(houseId) {
    const house = houses.find(h => h.id === houseId);
    if (house) {
        const newAddress = prompt("Modifier l'adresse:", house.address);
        if (newAddress && newAddress.trim() !== '' && newAddress !== house.address) {
            updateHouseAddress(houseId, newAddress.trim());
        }
    }
}

// INTERFACE UTILISATEUR
function editNote(houseId) {
    const house = houses.find(h => h.id === houseId);
    if (house) {
        editingMarkerId = houseId;
        document.getElementById('noteText').value = house.note;
        document.getElementById('noteEditor').style.display = 'block';
    }
}

function updateStats() {
    if (!currentUser) return;
    
    const userHouses = houses.filter(house => house.createdBy === currentUser.email);
    const total = userHouses.length;
    const bought = userHouses.filter(h => h.status === STATUS.BOUGHT).length;
    const notBought = userHouses.filter(h => h.status === STATUS.NOT_BOUGHT).length;
    const absent = userHouses.filter(h => h.status === STATUS.ABSENT).length;
    const score = calculateUserScore(currentUser.email);
    
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statBought').textContent = bought;
    document.getElementById('statNotBought').textContent = notBought;
    document.getElementById('statAbsent').textContent = absent;
    
    document.getElementById('userPseudo').textContent = currentUser.pseudo + ` (${score} pts)`;
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

// AUTHENTIFICATION
function login(email, password, pseudo, remember) {
    if (!email) {
        showError("Veuillez entrer votre email");
        return;
    }
    
    if (!pseudo) {
        showError("Veuillez choisir un pseudo");
        return;
    }
    
    if (!password) {
        showError("Veuillez entrer votre mot de passe");
        return;
    }
    
    if (password.length < 6) {
        showError("Le mot de passe doit faire au moins 6 caractères");
        return;
    }
    
    document.getElementById('loader').style.display = 'block';
    
    setTimeout(() => {
        const existingUser = users.find(u => u.email === email);
        
        if (existingUser) {
            if (existingUser.password !== password) {
                document.getElementById('loader').style.display = 'none';
                showError("Mot de passe incorrect");
                return;
            }
            
            if (existingUser.pseudo !== pseudo) {
                existingUser.pseudo = pseudo;
                saveUsers();
            }
        } else {
            users.push({
                email: email,
                pseudo: pseudo,
                password: password,
                createdAt: new Date().toISOString()
            });
            saveUsers();
        }
        
        currentUser = {
            email: email,
            pseudo: pseudo,
            isAdmin: email === ADMIN_EMAIL
        };
        
        saveRememberMe(email, pseudo, remember);
        
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('userPseudo').textContent = pseudo;
        
        if (currentUser.isAdmin) {
            document.getElementById('btnReset').style.display = 'block';
        } else {
            document.getElementById('btnReset').style.display = 'none';
        }
        
        setTimeout(() => {
            initMap();
            loadExistingHouses();
            updateStats();
            updateRanking();
            document.getElementById('loader').style.display = 'none';
        }, 100);
        
    }, 500);
}

function logout() {
    if (isTrackingLocation) {
        navigator.geolocation.clearWatch(watchId);
        isTrackingLocation = false;
    }
    
    if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
        userLocationMarker = null;
    }
    if (userLocationCircle) {
        map.removeLayer(userLocationCircle);
        userLocationCircle = null;
    }
    
    currentUser = null;
    
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('app').style.display = 'none';
    
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
}

function loadExistingHouses() {
    houses.forEach(house => {
        addMarker(house);
    });
}

function resetAllHouses() {
    if (confirm('⚠️ ATTENTION ! Voulez-vous supprimer TOUTES les maisons ? Cette action est irréversible.')) {
        markers.forEach(marker => {
            map.removeLayer(marker);
        });
        markers.clear();
        
        houses = [];
        saveHouses();
        
        updateStats();
        updateRanking();
        
        alert("✅ Toutes les maisons ont été supprimées");
    }
}

// FONCTION POUR AJOUTER UNE MAISON
function addNewHouse() {
    if (!currentUser) return;
    
    // Demander si on veut utiliser la position actuelle
    if (navigator.geolocation && confirm("Voulez-vous utiliser votre position actuelle pour placer la maison ?")) {
        showLoader();
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                hideLoader();
                showPaymentPopup(lat, lng);
            },
            function(error) {
                hideLoader();
                // Si la géolocalisation échoue, utiliser le centre de la carte
                const center = map.getCenter();
                showPaymentPopup(center.lat, center.lng);
            }
        );
    } else {
        // Utiliser le centre de la carte
        const center = map.getCenter();
        showPaymentPopup(center.lat, center.lng);
    }
}

// GESTION MOBILE
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
    
    setTimeout(() => {
        if (map) {
            map.invalidateSize();
        }
    }, 300);
}

function toggleUserMenu() {
    document.getElementById('userSection').classList.toggle('mobile-visible');
}

// GESTION DES ÉVÉNEMENTS
document.addEventListener('DOMContentLoaded', function() {
    console.log("🚀 Calentour prêt à démarrer");
    
    // Vérifier "Se souvenir de moi" au chargement
    if (loadRememberMe()) {
        console.log("✅ Session précédente chargée");
    }
    
    // Boutons de connexion
    document.getElementById('btnLogin').addEventListener('click', function() {
        const email = document.getElementById('email').value;
        const pseudo = document.getElementById('pseudo').value;
        const password = document.getElementById('password').value;
        const remember = document.getElementById('rememberMe').checked;
        login(email, password, pseudo, remember);
    });
    
    document.getElementById('btnSignup').addEventListener('click', function() {
        const email = document.getElementById('email').value;
        const pseudo = document.getElementById('pseudo').value;
        const password = document.getElementById('password').value;
        const remember = document.getElementById('rememberMe').checked;
        login(email, password, pseudo, remember);
    });
    
    // Entrée pour se connecter
    document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const email = document.getElementById('email').value;
            const pseudo = document.getElementById('pseudo').value;
            const password = this.value;
            const remember = document.getElementById('rememberMe').checked;
            login(email, password, pseudo, remember);
        }
    });
    
    // Bouton de déconnexion
    document.getElementById('btnLogout').addEventListener('click', logout);
    
    // Bouton RESET (admin seulement)
    document.getElementById('btnReset').addEventListener('click', resetAllHouses);
    
    // Bouton de localisation
    document.getElementById('btnLocate').addEventListener('click', locateUser);
    
    // Bouton de suivi
    document.getElementById('btnTrack').addEventListener('click', toggleLocationTracking);
    
    // Bouton des statistiques
    document.getElementById('btnChart').addEventListener('click', showChartScreen);
    
    // Bouton pour ajouter une maison
    document.getElementById('btnAddHouse').addEventListener('click', addNewHouse);
    document.getElementById('btnFloatingAdd').addEventListener('click', addNewHouse);
    
    // Bouton pour fermer les statistiques
    document.getElementById('btnCloseChart').addEventListener('click', hideChartScreen);
    
    // Bouton flottant pour mobile
    document.querySelector('.floating-locate button').addEventListener('click', locateUser);
    
    // Éditeur de note
    document.getElementById('btnSaveNote').addEventListener('click', function() {
        if (editingMarkerId) {
            const newNote = document.getElementById('noteText').value;
            updateHouseNote(editingMarkerId, newNote);
            document.getElementById('noteEditor').style.display = 'none';
            editingMarkerId = null;
        }
    });
    
    document.getElementById('btnCancelNote').addEventListener('click', function() {
        document.getElementById('noteEditor').style.display = 'none';
        editingMarkerId = null;
    });
    
    // Popup de paiement
    document.getElementById('btnCancelPayment').addEventListener('click', hidePaymentPopup);
    document.getElementById('btnSavePayment').addEventListener('click', savePaymentInfo);
    
    // Menu mobile
    document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
    document.getElementById('userToggle').addEventListener('click', toggleUserMenu);
    
    // Overlay pour fermer le sidebar
    document.getElementById('sidebarOverlay').addEventListener('click', toggleSidebar);
    
    // Fermer le popup de paiement en cliquant en dehors
    document.addEventListener('click', function(e) {
        const paymentPopup = document.getElementById('paymentPopup');
        if (paymentPopup.style.display === 'block' && 
            !paymentPopup.contains(e.target) && 
            e.target.id !== 'map') {
            hidePaymentPopup();
        }
    });
    
    // Fermer le menu utilisateur au clic en dehors
    document.addEventListener('click', function(e) {
        const userSection = document.getElementById('userSection');
        const userToggle = document.getElementById('userToggle');
        
        if (!userSection.contains(e.target) && !userToggle.contains(e.target)) {
            userSection.classList.remove('mobile-visible');
        }
    });
    
    // Redimensionner la carte quand la fenêtre change
    window.addEventListener('resize', function() {
        if (map) {
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }
        
        if (document.getElementById('chartScreen').style.display === 'block') {
            setTimeout(() => {
                updateCharts();
            }, 100);
        }
    });
    
    console.log("✅ Événements configurés");
});

console.log("✅ Calentour chargé avec succès");
</script>

</body>
</html>