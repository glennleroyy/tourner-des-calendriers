<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calentour - Calendrier Pompiers</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Style g√©n√©ral */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f0f0f0;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* En-t√™te */
        .header {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            position: relative;
            z-index: 100;
            flex-shrink: 0;
            height: 60px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .calendar-icon {
            font-size: 28px;
            color: white;
            background: #ff9800;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        
        .logo h1 {
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .user-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Boutons */
        button {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #f57c00;
        }
        
        .btn-logout {
            background-color: #555;
        }
        
        .btn-logout:hover {
            background-color: #333;
        }
        
        .btn-reset {
            background-color: #f44336;
        }
        
        .btn-reset:hover {
            background-color: #d32f2f;
        }
        
        .btn-locate {
            background-color: #2196F3;
        }
        
        .btn-locate:hover {
            background-color: #1976D2;
        }
        
        .btn-track {
            background-color: #9C27B0;
        }
        
        .btn-track:hover {
            background-color: #7B1FA2;
        }
        
        /* Menu mobile */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
        }
        
        /* Contenu principal - CORRIG√â POUR PC */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            height: calc(100vh - 60px); /* Hauteur fixe pour PC */
        }
        
        /* Carte - CORRIG√â POUR PC */
        #map {
            flex: 1;
            height: 100%;
            width: 100%;
            z-index: 1;
            min-height: 400px; /* Hauteur minimum pour PC */
        }
        
        /* Barre lat√©rale */
        .sidebar {
            width: 350px;
            background-color: white;
            padding: 15px;
            overflow-y: auto;
            box-shadow: -3px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: transform 0.3s ease;
            position: relative;
            z-index: 50;
        }
        
        /* Overlay pour mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 49;
        }
        
        /* Sections */
        .section {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e0e0e0;
        }
        
        .section h3 {
            color: #d32f2f;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #d32f2f;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .stat-item {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }
        
        /* Classement */
        .ranking-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            background-color: white;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        
        .rank {
            font-weight: bold;
            color: #d32f2f;
            min-width: 25px;
        }
        
        .rank-1 {
            color: #FFD700; /* Or */
        }
        
        .rank-2 {
            color: #C0C0C0; /* Argent */
        }
        
        .rank-3 {
            color: #CD7F32; /* Bronze */
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #d32f2f;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .user-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        .user-score {
            font-weight: bold;
            color: #333;
            min-width: 40px;
            text-align: right;
        }
        
        /* L√©gende */
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .color-box {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        
        /* Fen√™tre popup */
        .popup-content {
            padding: 10px;
            min-width: 250px;
            max-width: 300px;
        }
        
        .popup-address {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        
        .popup-note {
            font-style: italic;
            background-color: #f5f5f5;
            padding: 6px;
            border-radius: 5px;
            margin-bottom: 12px;
            font-size: 13px;
            word-break: break-word;
        }
        
        .status-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .status-btn {
            padding: 8px 5px;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .status-btn:hover {
            transform: scale(1.05);
        }
        
        .popup-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .btn-delete {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-delete:hover {
            background-color: #d32f2f;
        }
        
        .btn-edit {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-edit:hover {
            background-color: #1976D2;
        }
        
        /* √âcran de connexion */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            padding: 20px;
        }
        
        .login-box {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .login-box h2 {
            text-align: center;
            color: #d32f2f;
            margin-bottom: 20px;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-box .calendar-icon {
            background: #d32f2f;
            width: 35px;
            height: 35px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
            font-size: 14px;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #d32f2f;
        }
        
        .login-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-login {
            background-color: #d32f2f;
            width: 100%;
            justify-content: center;
            padding: 12px;
        }
        
        .btn-signup {
            background-color: #555;
            width: 100%;
            justify-content: center;
            padding: 12px;
        }
        
        .error-message {
            color: #f44336;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 5px;
            display: none;
            font-size: 14px;
        }
        
        /* √âditeur de note */
        .note-editor {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .note-editor h3 {
            margin-bottom: 15px;
            color: #d32f2f;
        }
        
        .note-editor textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .note-editor textarea:focus {
            outline: none;
            border-color: #d32f2f;
        }
        
        .note-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Chargement */
        .loader {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 6px solid rgba(211, 47, 47, 0.3);
            border-top: 6px solid #d32f2f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Style pour le marqueur de position utilisateur */
        .user-location-marker {
            background-color: #2196F3;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-location-pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(33, 150, 243, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(33, 150, 243, 0);
            }
        }
        
        /* Bouton flottant pour mobile */
        .floating-locate {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .floating-locate button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #2196F3;
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* Animation pour les points */
        @keyframes housePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .new-house {
            animation: housePulse 0.5s ease-in-out 3;
        }
        
        /* Responsive - Mobile */
        @media (max-width: 768px) {
            .header {
                padding: 10px;
                height: 60px;
            }
            
            .logo h1 {
                font-size: 18px;
            }
            
            .calendar-icon {
                width: 35px;
                height: 35px;
                font-size: 24px;
            }
            
            .menu-toggle {
                display: flex;
            }
            
            .user-section {
                display: none;
                position: absolute;
                top: 60px;
                right: 0;
                background-color: #d32f2f;
                padding: 15px;
                border-radius: 0 0 0 10px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                z-index: 101;
                flex-direction: column;
                width: 200px;
                gap: 8px;
            }
            
            .user-section.mobile-visible {
                display: flex;
            }
            
            .container {
                flex-direction: column;
                height: calc(100vh - 60px);
            }
            
            #map {
                height: 100%;
                width: 100%;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
            }
            
            .sidebar {
                position: fixed;
                right: 0;
                top: 60px;
                bottom: 0;
                width: 85%;
                max-width: 320px;
                transform: translateX(100%);
                z-index: 100;
                background-color: white;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar-overlay.active {
                display: block;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stat-number {
                font-size: 18px;
            }
            
            button {
                padding: 6px 10px;
                font-size: 13px;
            }
            
            .popup-content {
                min-width: 220px;
                max-width: 280px;
            }
            
            .floating-locate {
                display: block;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                width: 90%;
            }
            
            .login-box {
                padding: 20px;
            }
            
            .login-box h2 {
                font-size: 20px;
            }
            
            .section {
                padding: 12px;
            }
            
            .section h3 {
                font-size: 15px;
            }
        }
        
        /* Pour PC - Correction suppl√©mentaire */
        @media (min-width: 769px) {
            .container {
                height: calc(100vh - 60px);
            }
            
            #map {
                height: 100%;
                min-height: 500px;
            }
        }
        
        /* Barre de d√©filement */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #d32f2f;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #b71c1c;
        }
    </style>
</head>
<body>

<!-- √âcran de connexion -->
<div id="loginScreen" class="login-screen">
    <div class="login-box">
        <h2>
            <div class="calendar-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            Calentour
        </h2>
        <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 14px;">
            Tourn√©e du calendrier des pompiers
        </p>
        
        <div class="input-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="votre@email.com">
        </div>
        
        <div class="input-group">
            <label for="pseudo">Pseudo (visible par tous)</label>
            <input type="text" id="pseudo" placeholder="Votre pseudo">
        </div>
        
        <div class="input-group">
            <label for="password">Mot de passe</label>
            <input type="password" id="password" placeholder="Votre mot de passe">
        </div>
        
        <div class="login-buttons">
            <button id="btnLogin" class="btn-login">
                <i class="fas fa-sign-in-alt"></i> Se connecter
            </button>
            <button id="btnSignup" class="btn-signup">
                <i class="fas fa-user-plus"></i> Cr√©er un compte
            </button>
        </div>
        
        <div id="errorMessage" class="error-message"></div>
    </div>
</div>

<!-- Application principale -->
<div id="app" style="display: none;">
    <div class="header">
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="logo">
            <div class="calendar-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <h1>Calentour</h1>
        </div>
        
        <button class="menu-toggle" id="userToggle">
            <i class="fas fa-user"></i>
        </button>
        
        <div class="user-section" id="userSection">
            <button id="btnLocate" class="btn-locate">
                <i class="fas fa-location-arrow"></i> Ma position
            </button>
            <button id="btnTrack" class="btn-track">
                <i class="fas fa-satellite"></i> Suivre
            </button>
            <span id="userPseudo"></span>
            <button id="btnLogout" class="btn-logout">
                <i class="fas fa-sign-out-alt"></i> D√©connexion
            </button>
            <button id="btnReset" class="btn-reset" style="display: none;">
                <i class="fas fa-trash"></i> Reset
            </button>
        </div>
    </div>
    
    <div class="container">
        <div id="map"></div>
        
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <div class="sidebar" id="sidebar">
            <div class="section">
                <h3><i class="fas fa-chart-bar"></i> Mes Statistiques</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="statTotal">0</div>
                        <div class="stat-label">Total maisons</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="statBought">0</div>
                        <div class="stat-label">Achet√©s</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="statNotBought">0</div>
                        <div class="stat-label">Non achet√©s</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="statAbsent">0</div>
                        <div class="stat-label">Absents</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-trophy"></i> Classement</h3>
                <div class="ranking-list" id="rankingList">
                    <div style="text-align: center; color: #888; padding: 20px;">Chargement...</div>
                </div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-key"></i> L√©gende</h3>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #9E9E9E;"></div>
                    <span>Non pass√©</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #4CAF50;"></div>
                    <span>Achet√©</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #FF5722;"></div>
                    <span>Non achet√©</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #2196F3;"></div>
                    <span>Absent</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background-color: #2196F3; border: 2px dashed #fff;"></div>
                    <span>Votre position</span>
                </div>
            </div>
            
            <div class="section">
                <h3><i class="fas fa-info-circle"></i> Instructions</h3>
                <p style="font-size: 13px; line-height: 1.4; color: #555;">
                    1. <strong>Cliquez sur la carte</strong> pour ajouter une maison<br>
                    2. <strong>Cliquez sur un point</strong> pour changer le statut<br>
                    3. <strong>Bouton "Ma position"</strong> : vous localise sur la carte<br>
                    4. <strong>Bouton "Suivre"</strong> : suit votre d√©placement<br>
                    5. <strong>Classement</strong> : 10pts achet√©, 5pts absent, 1pt non achet√©<br>
                    6. <strong>RESET</strong> : admin seulement
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Bouton flottant pour mobile -->
<div id="floatingLocate" class="floating-locate">
    <button>
        <i class="fas fa-location-arrow"></i>
    </button>
</div>

<!-- √âditeur de note -->
<div id="noteEditor" class="note-editor">
    <h3>Modifier la note</h3>
    <textarea id="noteText" placeholder="Ex: Repasser apr√®s 18h, 2√®me √©tage, chien m√©chant..."></textarea>
    <div class="note-buttons">
        <button id="btnCancelNote" style="background-color: #777;">Annuler</button>
        <button id="btnSaveNote" style="background-color: #d32f2f;">Enregistrer</button>
    </div>
</div>

<!-- Chargement -->
<div id="loader" class="loader">
    <div class="spinner"></div>
</div>

<!-- Script JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// CONFIGURATION
let map;
let markers = new Map();
let currentUser = null;
let editingMarkerId = null;

// Variables pour la g√©olocalisation
let userLocationMarker = null;
let userLocationCircle = null;
let isTrackingLocation = false;
let watchId = null;

// Email de l'admin (VOUS)
const ADMIN_EMAIL = "objectifcup@gmail.com";

// Donn√©es (stockage local)
let houses = JSON.parse(localStorage.getItem('calentour_houses')) || [];
let users = JSON.parse(localStorage.getItem('calentour_users')) || [];

// Syst√®me de points
const POINTS = {
    'achet√©': 10,     // 10 points pour un calendrier achet√©
    'absent': 5,      // 5 points pour avoir trouv√© quelqu'un absent
    'non_achet√©': 1,  // 1 point pour avoir tent√©
    'non_pass√©': 0    // 0 point pour non pass√©
};

// Statuts des maisons
const STATUS = {
    NOT_PASSED: 'non_pass√©',
    BOUGHT: 'achet√©',
    NOT_BOUGHT: 'non_achet√©',
    ABSENT: 'absent'
};

// Couleurs pour chaque statut
const STATUS_COLORS = {
    'non_pass√©': '#9E9E9E',
    'achet√©': '#4CAF50',
    'non_achet√©': '#FF5722',
    'absent': '#2196F3'
};

// Cr√©ation des ic√¥nes pour la carte
const STATUS_ICONS = {};
for (const [status, color] of Object.entries(STATUS_COLORS)) {
    STATUS_ICONS[status] = L.divIcon({
        html: `<div style="background-color: ${color}; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>`,
        iconSize: [25, 25],
        iconAnchor: [12, 12],
        className: 'house-marker'
    });
}

// FONCTIONS UTILITAIRES

// R√©cup√©rer les initiales d'un pseudo
function getInitials(name) {
    return name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2);
}

// Calculer le score d'un utilisateur
function calculateUserScore(email) {
    const userHouses = houses.filter(house => house.createdBy === email);
    return userHouses.reduce((total, house) => total + (POINTS[house.status] || 0), 0);
}

// Calculer tous les scores
function calculateAllScores() {
    const scores = {};
    
    users.forEach(user => {
        scores[user.email] = {
            pseudo: user.pseudo,
            score: calculateUserScore(user.email),
            email: user.email
        };
    });
    
    return Object.values(scores).sort((a, b) => b.score - a.score);
}

// FONCTIONS DE G√âOLOCALISATION

function locateUser() {
    if (!navigator.geolocation) {
        alert("La g√©olocalisation n'est pas support√©e par votre navigateur");
        return;
    }
    
    showLoader();
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            // V√©rifier si on est en Bretagne
            if (!isInBrittany(lat, lng)) {
                hideLoader();
                if (!confirm("Vous semblez √™tre en dehors de la Bretagne. Voulez-vous quand m√™me centrer la carte sur votre position ?")) {
                    return;
                }
            }
            
            // Centrer la carte sur la position de l'utilisateur
            map.setView([lat, lng], 16);
            
            // Ajouter ou mettre √† jour le marqueur
            updateUserLocationMarker(lat, lng, accuracy);
            
            hideLoader();
            
            console.log("üìç Position trouv√©e:", lat, lng, "Pr√©cision:", accuracy, "m");
        },
        function(error) {
            hideLoader();
            
            let errorMessage;
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Vous avez refus√© la g√©olocalisation. Activez-la dans les param√®tres de votre navigateur.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Les informations de localisation sont indisponibles.";
                    break;
                case error.TIMEOUT:
                    errorMessage = "La requ√™te de localisation a expir√©.";
                    break;
                default:
                    errorMessage = "Une erreur inconnue est survenue.";
            }
            
            alert("Erreur de g√©olocalisation : " + errorMessage);
            console.error("‚ùå Erreur de g√©olocalisation:", error);
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

function toggleLocationTracking() {
    if (!navigator.geolocation) {
        alert("La g√©olocalisation n'est pas support√©e par votre navigateur");
        return;
    }
    
    if (isTrackingLocation) {
        // Arr√™ter le suivi
        navigator.geolocation.clearWatch(watchId);
        isTrackingLocation = false;
        document.getElementById('btnTrack').innerHTML = '<i class="fas fa-satellite"></i> Suivre';
        console.log("üìç Suivi de position arr√™t√©");
    } else {
        // D√©marrer le suivi
        showLoader();
        
        watchId = navigator.geolocation.watchPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                updateUserLocationMarker(lat, lng, accuracy);
                
                // Si c'est la premi√®re position, centrer la carte
                if (!isTrackingLocation) {
                    map.setView([lat, lng], 16);
                }
                
                isTrackingLocation = true;
                hideLoader();
                document.getElementById('btnTrack').innerHTML = '<i class="fas fa-satellite-dish"></i> Arr√™ter';
                
                console.log("üìç Position mise √† jour:", lat, lng);
            },
            function(error) {
                hideLoader();
                console.error("‚ùå Erreur de suivi:", error);
                
                if (error.code === error.PERMISSION_DENIED) {
                    alert("Permission de g√©olocalisation refus√©e. Activez-la dans les param√®tres.");
                }
            },
            {
                enableHighAccuracy: true,
                maximumAge: 10000,
                timeout: 5000
            }
        );
    }
}

function updateUserLocationMarker(lat, lng, accuracy) {
    // Supprimer l'ancien marqueur s'il existe
    if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
    }
    if (userLocationCircle) {
        map.removeLayer(userLocationCircle);
    }
    
    // Cr√©er un marqueur personnalis√© pour la position de l'utilisateur
    const userIcon = L.divIcon({
        html: `<div class="user-location-marker user-location-pulse">
                  <i class="fas fa-user" style="color: white; font-size: 10px;"></i>
               </div>`,
        iconSize: [20, 20],
        iconAnchor: [10, 10],
        className: 'user-location-icon'
    });
    
    // Ajouter le marqueur
    userLocationMarker = L.marker([lat, lng], {
        icon: userIcon,
        zIndexOffset: 1000
    }).addTo(map);
    
    // Ajouter un cercle de pr√©cision
    if (accuracy < 1000) {
        userLocationCircle = L.circle([lat, lng], {
            color: '#2196F3',
            fillColor: '#2196F3',
            fillOpacity: 0.1,
            radius: accuracy
        }).addTo(map);
    }
    
    // Ajouter un popup d'information
    userLocationMarker.bindPopup(`
        <div style="text-align: center; padding: 5px;">
            <strong>Votre position</strong><br>
            Pr√©cision: ${Math.round(accuracy)} m√®tres<br>
            <small>${lat.toFixed(5)}, ${lng.toFixed(5)}</small>
        </div>
    `);
}

function isInBrittany(lat, lng) {
    // V√©rifier si les coordonn√©es sont dans les limites de la Bretagne
    return lat >= 47.0 && lat <= 49.0 && lng >= -5.0 && lng <= -1.0;
}

function showLoader() {
    document.getElementById('loader').style.display = 'block';
}

function hideLoader() {
    document.getElementById('loader').style.display = 'none';
}

// Mettre √† jour le classement
function updateRanking() {
    const scores = calculateAllScores();
    const rankingList = document.getElementById('rankingList');
    
    if (scores.length === 0) {
        rankingList.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">Aucun score disponible</div>';
        return;
    }
    
    let html = '';
    scores.forEach((user, index) => {
        const rankClass = `rank rank-${index + 1}`;
        const initials = getInitials(user.pseudo);
        
        html += `
            <div class="ranking-item">
                <span class="${rankClass}">${index + 1}</span>
                <div class="user-info">
                    <div class="user-avatar" style="background-color: ${index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : '#d32f2f'}">
                        ${initials}
                    </div>
                    <span class="user-name">${user.pseudo}</span>
                </div>
                <span class="user-score">${user.score} pts</span>
            </div>
        `;
    });
    
    rankingList.innerHTML = html;
}

// INITIALISATION DE LA CARTE - SIMPLIFI√âE
function initMap() {
    console.log("üó∫Ô∏è Initialisation de la carte de Bretagne...");
    
    // Vider la carte si elle existe d√©j√†
    if (map) {
        map.remove();
    }
    
    // Cr√©er la carte avec une hauteur fixe
    map = L.map('map');
    
    // Centrer sur la Bretagne
    map.setView([48.2020, -2.9326], 9);
    
    // Ajouter les tuiles OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        maxZoom: 18,
        minZoom: 8
    }).addTo(map);
    
    // D√©finir les limites pour la Bretagne
    const bounds = L.latLngBounds(
        [47.0, -5.0], // Sud-ouest
        [49.0, -1.0]  // Nord-est
    );
    
    // Sur PC seulement, limiter la carte √† la Bretagne
    if (window.innerWidth > 768) {
        map.setMaxBounds(bounds);
    }
    
    // G√©rer le clic sur la carte
    map.on('click', function(e) {
        if (!currentUser) return;
        
        console.log("üìç Clic sur la carte √†:", e.latlng.lat, e.latlng.lng);
        addHouse(e.latlng.lat, e.latlng.lng);
    });
    
    // S'assurer que la carte est correctement dimensionn√©e
    setTimeout(() => {
        map.invalidateSize();
        console.log("‚úÖ Carte redimensionn√©e");
    }, 100);
    
    console.log("‚úÖ Carte initialis√©e avec succ√®s");
}

// GESTION DES MAISONS

function addHouse(lat, lng) {
    // Cr√©er un ID unique
    const id = 'house_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Cr√©er la maison
    const house = {
        id: id,
        lat: lat,
        lng: lng,
        address: `Maison √† ${lat.toFixed(5)}, ${lng.toFixed(5)}`,
        status: STATUS.NOT_PASSED,
        note: '',
        createdBy: currentUser.email,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };
    
    // Ajouter √† la liste
    houses.push(house);
    
    // Sauvegarder
    saveHouses();
    
    // Ajouter le marqueur
    addMarker(house);
    
    // Mettre √† jour les statistiques
    updateStats();
    
    // Mettre √† jour le classement
    updateRanking();
    
    console.log("‚úÖ Maison ajout√©e:", house);
}

function updateHouseStatus(id, newStatus) {
    const house = houses.find(h => h.id === id);
    if (house) {
        house.status = newStatus;
        house.updatedAt = new Date().toISOString();
        
        // Mettre √† jour le marqueur
        updateMarker(house);
        
        // Sauvegarder
        saveHouses();
        
        // Mettre √† jour les statistiques
        updateStats();
        
        // Mettre √† jour le classement
        updateRanking();
        
        console.log("üîÑ Statut mis √† jour:", house);
    }
}

function updateHouseNote(id, newNote) {
    const house = houses.find(h => h.id === id);
    if (house) {
        house.note = newNote;
        house.updatedAt = new Date().toISOString();
        
        // Mettre √† jour le marqueur
        updateMarker(house);
        
        // Sauvegarder
        saveHouses();
        
        console.log("üìù Note mise √† jour:", house);
    }
}

function deleteHouse(id) {
    // Supprimer de la liste
    houses = houses.filter(h => h.id !== id);
    
    // Supprimer le marqueur
    removeMarker(id);
    
    // Sauvegarder
    saveHouses();
    
    // Mettre √† jour les statistiques
    updateStats();
    
    // Mettre √† jour le classement
    updateRanking();
    
    console.log("üóëÔ∏è Maison supprim√©e:", id);
}

function saveHouses() {
    localStorage.setItem('calentour_houses', JSON.stringify(houses));
}

function saveUsers() {
    localStorage.setItem('calentour_users', JSON.stringify(users));
}

// GESTION DES MARQUEURS

function addMarker(house) {
    const marker = L.marker([house.lat, house.lng], {
        icon: STATUS_ICONS[house.status],
        title: house.address
    }).addTo(map);
    
    markers.set(house.id, marker);
    
    marker.bindPopup(createPopupContent(house), {
        maxWidth: 300
    });
    
    // Animation pour nouveau marqueur
    marker.getElement().classList.add('new-house');
    
    marker.on('popupopen', function() {
        setTimeout(() => {
            const popupElement = marker.getPopup().getElement();
            
            // Boutons de statut
            const statusButtons = popupElement.querySelectorAll('.status-btn');
            statusButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const houseId = this.getAttribute('data-id');
                    const newStatus = this.getAttribute('data-status');
                    
                    updateHouseStatus(houseId, newStatus);
                    
                    marker.closePopup();
                    setTimeout(() => {
                        marker.openPopup();
                    }, 100);
                });
            });
            
            // Bouton de suppression
            const deleteBtn = popupElement.querySelector('.btn-delete');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const houseId = this.getAttribute('data-id');
                    
                    if (confirm('Voulez-vous vraiment supprimer cette maison ?')) {
                        deleteHouse(houseId);
                    }
                });
            }
            
            // Bouton d'√©dition de note
            const editBtn = popupElement.querySelector('.btn-edit');
            if (editBtn) {
                editBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const houseId = this.getAttribute('data-id');
                    editNote(houseId);
                });
            }
        }, 10);
    });
}

function updateMarker(house) {
    const marker = markers.get(house.id);
    if (marker) {
        marker.setIcon(STATUS_ICONS[house.status]);
        marker.setPopupContent(createPopupContent(house));
    }
}

function removeMarker(id) {
    const marker = markers.get(id);
    if (marker) {
        map.removeLayer(marker);
        markers.delete(id);
    }
}

function createPopupContent(house) {
    const user = users.find(u => u.email === house.createdBy);
    const creatorName = user ? user.pseudo : 'Inconnu';
    
    return `
        <div class="popup-content">
            <div class="popup-address">${house.address}</div>
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                <i class="fas fa-user"></i> Ajout√© par ${creatorName}
            </div>
            ${house.note ? `<div class="popup-note">${house.note}</div>` : ''}
            
            <div class="status-buttons">
                <button class="status-btn" data-id="${house.id}" data-status="non_pass√©" 
                        style="background-color: ${STATUS_COLORS['non_pass√©']}">
                    Non pass√©
                </button>
                <button class="status-btn" data-id="${house.id}" data-status="achet√©" 
                        style="background-color: ${STATUS_COLORS['achet√©']}">
                    Achet√©
                </button>
                <button class="status-btn" data-id="${house.id}" data-status="non_achet√©" 
                        style="background-color: ${STATUS_COLORS['non_achet√©']}">
                    Non achet√©
                </button>
                <button class="status-btn" data-id="${house.id}" data-status="absent" 
                        style="background-color: ${STATUS_COLORS['absent']}">
                    Absent
                </button>
            </div>
            
            <div class="popup-actions">
                <button class="btn-edit" data-id="${house.id}">
                    <i class="fas fa-edit"></i> Note
                </button>
                <button class="btn-delete" data-id="${house.id}">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        </div>
    `;
}

// INTERFACE UTILISATEUR

function editNote(houseId) {
    const house = houses.find(h => h.id === houseId);
    if (house) {
        editingMarkerId = houseId;
        document.getElementById('noteText').value = house.note;
        document.getElementById('noteEditor').style.display = 'block';
    }
}

function updateStats() {
    if (!currentUser) return;
    
    const userHouses = houses.filter(house => house.createdBy === currentUser.email);
    const total = userHouses.length;
    const bought = userHouses.filter(h => h.status === STATUS.BOUGHT).length;
    const notBought = userHouses.filter(h => h.status === STATUS.NOT_BOUGHT).length;
    const absent = userHouses.filter(h => h.status === STATUS.ABSENT).length;
    const score = calculateUserScore(currentUser.email);
    
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statBought').textContent = bought;
    document.getElementById('statNotBought').textContent = notBought;
    document.getElementById('statAbsent').textContent = absent;
    
    // Mettre √† jour le pseudo dans le header
    document.getElementById('userPseudo').textContent = currentUser.pseudo + ` (${score} pts)`;
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

// AUTHENTIFICATION

function login(email, password, pseudo) {
    if (!email) {
        showError("Veuillez entrer votre email");
        return;
    }
    
    if (!pseudo) {
        showError("Veuillez choisir un pseudo");
        return;
    }
    
    if (!password) {
        showError("Veuillez entrer votre mot de passe");
        return;
    }
    
    if (password.length < 6) {
        showError("Le mot de passe doit faire au moins 6 caract√®res");
        return;
    }
    
    document.getElementById('loader').style.display = 'block';
    
    setTimeout(() => {
        // V√©rifier si l'utilisateur existe
        const existingUser = users.find(u => u.email === email);
        
        if (existingUser) {
            // V√©rifier le mot de passe
            if (existingUser.password !== password) {
                document.getElementById('loader').style.display = 'none';
                showError("Mot de passe incorrect");
                return;
            }
            
            // Mettre √† jour le pseudo si chang√©
            if (existingUser.pseudo !== pseudo) {
                existingUser.pseudo = pseudo;
                saveUsers();
            }
        } else {
            // Nouvel utilisateur
            users.push({
                email: email,
                pseudo: pseudo,
                password: password,
                createdAt: new Date().toISOString()
            });
            saveUsers();
        }
        
        currentUser = {
            email: email,
            pseudo: pseudo,
            isAdmin: email === ADMIN_EMAIL
        };
        
        // Cacher l'√©cran de connexion
        document.getElementById('loginScreen').style.display = 'none';
        // Afficher l'application
        document.getElementById('app').style.display = 'block';
        // Afficher le pseudo
        document.getElementById('userPseudo').textContent = pseudo;
        
        // Afficher le bouton RESET si admin
        if (currentUser.isAdmin) {
            document.getElementById('btnReset').style.display = 'block';
            console.log("üëë Mode administrateur activ√©");
        } else {
            document.getElementById('btnReset').style.display = 'none';
        }
        
        // Initialiser la carte
        setTimeout(() => {
            initMap();
            loadExistingHouses();
            
            // Mettre √† jour les statistiques
            updateStats();
            updateRanking();
            
            console.log("‚úÖ Connect√© en tant que:", pseudo);
            document.getElementById('loader').style.display = 'none';
        }, 100);
        
    }, 500);
}

function logout() {
    // Arr√™ter le suivi de position si actif
    if (isTrackingLocation) {
        navigator.geolocation.clearWatch(watchId);
        isTrackingLocation = false;
    }
    
    // Supprimer le marqueur de position
    if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
        userLocationMarker = null;
    }
    if (userLocationCircle) {
        map.removeLayer(userLocationCircle);
        userLocationCircle = null;
    }
    
    currentUser = null;
    
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('app').style.display = 'none';
    
    // Vider les champs de connexion
    document.getElementById('email').value = '';
    document.getElementById('pseudo').value = '';
    document.getElementById('password').value = '';
    
    console.log("‚úÖ D√©connect√©");
}

function loadExistingHouses() {
    houses.forEach(house => {
        addMarker(house);
    });
    
    console.log(`‚úÖ ${houses.length} maisons charg√©es`);
}

function resetAllHouses() {
    if (confirm('‚ö†Ô∏è ATTENTION ! Voulez-vous supprimer TOUTES les maisons ? Cette action est irr√©versible.')) {
        markers.forEach(marker => {
            map.removeLayer(marker);
        });
        markers.clear();
        
        houses = [];
        saveHouses();
        
        updateStats();
        updateRanking();
        
        console.log("‚úÖ Toutes les maisons ont √©t√© supprim√©es");
        alert("‚úÖ Toutes les maisons ont √©t√© supprim√©es");
    }
}

// GESTION MOBILE

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
    
    // Redimensionner la carte quand le sidebar s'ouvre/ferme
    setTimeout(() => {
        if (map) {
            map.invalidateSize();
        }
    }, 300);
}

function toggleUserMenu() {
    document.getElementById('userSection').classList.toggle('mobile-visible');
}

// GESTION DES √âV√âNEMENTS

document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ Calentour pr√™t √† d√©marrer");
    
    // Boutons de connexion
    document.getElementById('btnLogin').addEventListener('click', function() {
        const email = document.getElementById('email').value;
        const pseudo = document.getElementById('pseudo').value;
        const password = document.getElementById('password').value;
        login(email, password, pseudo);
    });
    
    document.getElementById('btnSignup').addEventListener('click', function() {
        const email = document.getElementById('email').value;
        const pseudo = document.getElementById('pseudo').value;
        const password = document.getElementById('password').value;
        login(email, password, pseudo);
    });
    
    // Entr√©e pour se connecter
    document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const email = document.getElementById('email').value;
            const pseudo = document.getElementById('pseudo').value;
            const password = this.value;
            login(email, password, pseudo);
        }
    });
    
    // Bouton de d√©connexion
    document.getElementById('btnLogout').addEventListener('click', logout);
    
    // Bouton RESET (admin seulement)
    document.getElementById('btnReset').addEventListener('click', resetAllHouses);
    
    // Bouton de localisation
    document.getElementById('btnLocate').addEventListener('click', locateUser);
    
    // Bouton de suivi
    document.getElementById('btnTrack').addEventListener('click', toggleLocationTracking);
    
    // Bouton flottant pour mobile
    document.querySelector('.floating-locate button').addEventListener('click', locateUser);
    
    // √âditeur de note
    document.getElementById('btnSaveNote').addEventListener('click', function() {
        if (editingMarkerId) {
            const newNote = document.getElementById('noteText').value;
            updateHouseNote(editingMarkerId, newNote);
            document.getElementById('noteEditor').style.display = 'none';
            editingMarkerId = null;
        }
    });
    
    document.getElementById('btnCancelNote').addEventListener('click', function() {
        document.getElementById('noteEditor').style.display = 'none';
        editingMarkerId = null;
    });
    
    // Menu mobile
    document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
    document.getElementById('userToggle').addEventListener('click', toggleUserMenu);
    
    // Overlay pour fermer le sidebar
    document.getElementById('sidebarOverlay').addEventListener('click', toggleSidebar);
    
    // Fermer le menu utilisateur au clic en dehors
    document.addEventListener('click', function(e) {
        const userSection = document.getElementById('userSection');
        const userToggle = document.getElementById('userToggle');
        
        if (!userSection.contains(e.target) && !userToggle.contains(e.target)) {
            userSection.classList.remove('mobile-visible');
        }
    });
    
    // Redimensionner la carte quand la fen√™tre change
    window.addEventListener('resize', function() {
        if (map) {
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }
    });
    
    console.log("‚úÖ √âv√©nements configur√©s");
});

console.log("‚úÖ Calentour charg√© avec succ√®s");
</script>

</body>
</html>